<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>So you want to use Redux (pt 1) — selectors</title>
  <meta name="description" content="I’m Sérgio, and I work with Web frontend code. Sometimes I write about it here.">

    <!--
      Hello, and welcome to the source for my site!
      There's not a lot to see around here, but I hope you get some inspiration/ideas/laughs.

      Here's an ASCII art stick figure saying hi:  o/
                                                  /|
                                                  / \

      Also, no, I'm not Spanish. I just like short domain names.
    -->

  <link rel="canonical" href="https://sgom.es/">
  <link rel="alternate" type="application/rss+xml" title="sgom.es" href="/feed.xml">

  <link rel="manifest" href="/manifest.json">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="sgom.es">
  <link rel="icon" sizes="16x16" href="/assets/images/touch/16x16.png">
  <link rel="icon" sizes="32x32" href="/assets/images/touch/32x32.png">
  <link rel="icon" sizes="192x192" href="/assets/images/touch/192x192.png">
  <link rel="icon" sizes="512x512" href="/assets/images/touch/512x512.png">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="sgom.es">
  <link rel="apple-touch-icon" href="/assets/images/touch/152x152.png">

  <meta name="msapplication-TileImage" content="/assets/images/touch/144x144.png">
  <meta name="msapplication-TileColor" content="#009688">

  <meta name="theme-color" content="#009688">

  <link rel="preconnect" href="https://fonts.gstatic.com">

  <style>
  
  @import url(https://fonts.googleapis.com/css?family=Roboto+Mono|Rubik:400,500&display=fallback);.header{display:flex;height:80px;background:#009688;background:var(--primary-color);color:#fff;justify-content:center;align-items:center;flex-shrink:0;z-index:2;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12)}.header-title{text-decoration:none;color:rgba(255,255,255,.9);-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline4-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:2.125rem;font-size:var(--mdc-typography-headline4-font-size,2.125rem);line-height:2.5rem;line-height:var(--mdc-typography-headline4-line-height,2.5rem);font-weight:400;font-weight:var(--mdc-typography-headline4-font-weight,400);letter-spacing:.0073529412em;letter-spacing:var(--mdc-typography-headline4-letter-spacing,.0073529412em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline4-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline4-text-transform,inherit);font-weight:700}.header-title:hover,.header-title:visited{color:rgba(255,255,255,.9)}.post{background:#fff;background:var(--post-background);padding:3.5rem 4.5rem;margin:0 auto;color:rgba(0,0,0,.87);color:var(--text-color);width:100%;max-width:45rem;box-sizing:border-box}@media screen and (max-width:600px){.post{padding:2rem 1rem}}.post-title{display:block;color:#009688;color:var(--primary-color-text);-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline4-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:2.125rem;font-size:var(--mdc-typography-headline4-font-size,2.125rem);line-height:2.5rem;line-height:var(--mdc-typography-headline4-line-height,2.5rem);font-weight:400;font-weight:var(--mdc-typography-headline4-font-weight,400);letter-spacing:.0073529412em;letter-spacing:var(--mdc-typography-headline4-letter-spacing,.0073529412em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline4-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline4-text-transform,inherit);margin-bottom:0;margin-top:0}.post-meta{display:block;color:#009688;color:var(--primary-color-text);-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-body2-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.875rem;font-size:var(--mdc-typography-body2-font-size,.875rem);line-height:1.25rem;line-height:var(--mdc-typography-body2-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-body2-font-weight,400);letter-spacing:.0178571429em;letter-spacing:var(--mdc-typography-body2-letter-spacing,.0178571429em);text-decoration:inherit;text-decoration:var(--mdc-typography-body2-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-body2-text-transform,inherit);margin-top:0}.post-image{max-width:100%;margin:0 auto}.post-image>img{display:block}.post-content{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-body1-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1rem;font-size:var(--mdc-typography-body1-font-size,1rem);line-height:1.5rem;line-height:var(--mdc-typography-body1-line-height,1.5rem);font-weight:400;font-weight:var(--mdc-typography-body1-font-weight,400);letter-spacing:.03125em;letter-spacing:var(--mdc-typography-body1-letter-spacing,.03125em);text-decoration:inherit;text-decoration:var(--mdc-typography-body1-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-body1-text-transform,inherit);font-size:1rem;letter-spacing:normal;box-sizing:border-box;margin:0}.post-content h1{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline5-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1.5rem;font-size:var(--mdc-typography-headline5-font-size,1.5rem);line-height:2rem;line-height:var(--mdc-typography-headline5-line-height,2rem);font-weight:400;font-weight:var(--mdc-typography-headline5-font-weight,400);letter-spacing:normal;letter-spacing:var(--mdc-typography-headline5-letter-spacing,normal);text-decoration:inherit;text-decoration:var(--mdc-typography-headline5-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline5-text-transform,inherit)}.post-content h2{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline6-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1.25rem;font-size:var(--mdc-typography-headline6-font-size,1.25rem);line-height:2rem;line-height:var(--mdc-typography-headline6-line-height,2rem);font-weight:500;font-weight:var(--mdc-typography-headline6-font-weight,500);letter-spacing:.0125em;letter-spacing:var(--mdc-typography-headline6-letter-spacing,.0125em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline6-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline6-text-transform,inherit);margin:0;margin-top:2rem}.post-content h2+h3{margin-top:1em}.post-content h3{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline6-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1.25rem;font-size:var(--mdc-typography-headline6-font-size,1.25rem);line-height:2rem;line-height:var(--mdc-typography-headline6-line-height,2rem);font-weight:500;font-weight:var(--mdc-typography-headline6-font-weight,500);letter-spacing:.0125em;letter-spacing:var(--mdc-typography-headline6-letter-spacing,.0125em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline6-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline6-text-transform,inherit);font-size:1.1rem;line-height:1.5rem;margin:2em 0 0}.post-content h4{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-body2-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.875rem;font-size:var(--mdc-typography-body2-font-size,.875rem);line-height:1.25rem;line-height:var(--mdc-typography-body2-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-body2-font-weight,400);letter-spacing:.0178571429em;letter-spacing:var(--mdc-typography-body2-letter-spacing,.0178571429em);text-decoration:inherit;text-decoration:var(--mdc-typography-body2-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-body2-text-transform,inherit);font-size:1rem;letter-spacing:normal;margin:2em 0 0;color:rgba(0,0,0,.6);color:var(--faded-color)}.post-content a{color:#009688;color:var(--primary-color-text);text-decoration-skip-ink:auto}.post-content a:hover,.post-content a:visited{color:#009688;color:var(--primary-color-text)}.post-content pre{border-radius:2px;margin:0;padding:16px;font-size:.9375em;font-style:normal;font-weight:400;letter-spacing:normal;line-height:normal;font-family:"Roboto Mono",monospace;overflow-x:auto}.post-content pre+pre{margin-top:16px}.post-content code{font-size:.9375em;color:#0d47a1;color:var(--code-color);font-family:"Roboto Mono",monospace}.post-content strong{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-body2-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.875rem;font-size:var(--mdc-typography-body2-font-size,.875rem);line-height:1.25rem;line-height:var(--mdc-typography-body2-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-body2-font-weight,400);letter-spacing:.0178571429em;letter-spacing:var(--mdc-typography-body2-letter-spacing,.0178571429em);text-decoration:inherit;text-decoration:var(--mdc-typography-body2-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-body2-text-transform,inherit);font-size:1rem;letter-spacing:normal}.post-content figure{max-width:100%;box-sizing:border-box;margin:0}.post-content figcaption{text-align:center;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-caption-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.75rem;font-size:var(--mdc-typography-caption-font-size,.75rem);line-height:1.25rem;line-height:var(--mdc-typography-caption-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-caption-font-weight,400);letter-spacing:.0333333333em;letter-spacing:var(--mdc-typography-caption-letter-spacing,.0333333333em);text-decoration:inherit;text-decoration:var(--mdc-typography-caption-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-caption-text-transform,inherit);margin:0}.post-content blockquote{margin:1.5em 0 2em 2.5em;border-left:1px solid #00bfa5;padding-left:1rem}.post-content table{display:block;margin:0 0 2rem;border-collapse:collapse;text-align:center;overflow-x:auto}.post-content table th{font-weight:500}.post-content table td,.post-content table th{padding:8px;border:1px solid #ddd}.post-content li+li{margin-top:.5rem}.post-content .overflow-x{overflow-x:auto}.post-tags{display:flex;align-items:baseline;flex-grow:1;line-height:normal;color:rgba(0,0,0,.6);color:var(--faded-color)}.post-tags-list{display:inline-block;flex-grow:1;margin-left:.2rem;font-family:"Roboto Mono",monospace;letter-spacing:normal}.footer{display:flex;flex-flow:column nowrap;width:100%;background:#009688;background:var(--primary-color);color:#fff;padding:16px;box-sizing:border-box;flex-shrink:0;z-index:2;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12)}.footer-contents{display:flex;position:relative;flex-flow:row nowrap;justify-content:center;align-items:center;margin:0 auto 0 auto;flex-shrink:0;box-sizing:border-box;padding:0 24px;width:100%;max-width:45rem}@media (max-width:600px){.footer-contents{flex-wrap:wrap;padding:0}}.footer-avatar{border-radius:10%;width:100px;height:100px;background:#000;flex-grow:0;flex-shrink:0;margin-right:16px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12)}.footer-text{flex-grow:1;flex-shrink:1;padding:16px;width:50%}.footer-heading{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline6-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1.25rem;font-size:var(--mdc-typography-headline6-font-size,1.25rem);line-height:2rem;line-height:var(--mdc-typography-headline6-line-height,2rem);font-weight:500;font-weight:var(--mdc-typography-headline6-font-weight,500);letter-spacing:.0125em;letter-spacing:var(--mdc-typography-headline6-letter-spacing,.0125em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline6-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline6-text-transform,inherit);margin-bottom:8px}.footer-description{margin:0}.footer-icons{display:block;flex-shrink:0;margin:.5rem 0}.footer-icons-row{display:block;flex-shrink:0}@media (max-width:600px){.footer-icons-row{display:inline-block}}.footer-bubble{display:inline-block;border-radius:50%;height:40px;width:40px;flex-shrink:0;margin:2px;background-repeat:no-repeat;background-size:contain;background-position:center}.footer-twitter{background-image:url(/assets/images/twitter.svg)}.footer-github{border-radius:0;background-image:url(/assets/images/github.svg)}.footer-email{background-image:url(/assets/images/email.svg)}.footer-feed{background-image:url(/assets/images/feed.svg)}.footer-bottom{display:flex;position:relative;justify-content:center;margin:8px auto 0 auto;flex-shrink:0;width:100%;max-width:45rem}.footer-bottom::before{display:block;position:absolute;top:50%;width:100%;height:1px;background:rgba(255,255,255,.17);content:""}.footer-copyright{display:inline-block;text-align:center;background:#009688;background:var(--primary-color);z-index:2;padding:0 8px;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-caption-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.75rem;font-size:var(--mdc-typography-caption-font-size,.75rem);line-height:1.25rem;line-height:var(--mdc-typography-caption-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-caption-font-weight,400);letter-spacing:.0333333333em;letter-spacing:var(--mdc-typography-caption-letter-spacing,.0333333333em);text-decoration:inherit;text-decoration:var(--mdc-typography-caption-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-caption-text-transform,inherit);margin:0}.footer-copyright a{color:rgba(255,255,255,.9);text-decoration:none;font-weight:700}.footer-copyright a:hover,.footer-copyright a:visited{color:rgba(255,255,255,.9)}.light-mode.light-mode,:root{--syntax-red:#B71C1C;--syntax-orange:#E65100;--syntax-green:#1B5E20;--syntax-cyan:#006064;--syntax-blue:#0D47A1;--syntax-purple:#4A148C;--syntax-brown:#3E2723;--syntax-yellow:#3E2723;--syntax-gray:#616161;--syntax-text:rgba(0, 0, 0, 0.87);--syntax-separator:#373B41;--syntax-background:#F5F5F5}@media (prefers-color-scheme:dark){:root{--syntax-red:#EF9A9A;--syntax-orange:#FFCC80;--syntax-green:#A5D6A7;--syntax-cyan:#80DEEA;--syntax-blue:#90CAF9;--syntax-purple:#CE93D8;--syntax-brown:#BCAAA4;--syntax-yellow:#FFF59D;--syntax-gray:#BDBDBD;--syntax-text:#F5F5F5;--syntax-separator:#BFCDE3;--syntax-background:#212121}}.dark-mode.dark-mode{--syntax-red:#EF9A9A;--syntax-orange:#FFCC80;--syntax-green:#A5D6A7;--syntax-cyan:#80DEEA;--syntax-blue:#90CAF9;--syntax-purple:#CE93D8;--syntax-brown:#BCAAA4;--syntax-yellow:#FFF59D;--syntax-gray:#BDBDBD;--syntax-text:#F5F5F5;--syntax-separator:#BFCDE3;--syntax-background:#212121}.post-content pre{background:#f5f5f5;background:var(--syntax-background)}.post-content pre code{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .comment{color:#616161;color:var(--syntax-gray)}.post-content pre code .comment .markup.link{color:#616161;color:var(--syntax-gray)}.post-content pre code .entity.name.type{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .entity.other.inherited-class{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .keyword{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .keyword.control{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .keyword.operator{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .keyword.other.special-method{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .keyword.other.unit{color:#e65100;color:var(--syntax-orange)}.post-content pre code .storage{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .constant{color:#e65100;color:var(--syntax-orange)}.post-content pre code .constant.character.escape{color:#006064;color:var(--syntax-cyan)}.post-content pre code .constant.numeric{color:#e65100;color:var(--syntax-orange)}.post-content pre code .constant.other.color{color:#006064;color:var(--syntax-cyan)}.post-content pre code .constant.other.symbol{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .variable{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .variable.interpolation{color:#3e2723;color:var(--syntax-brown)}.post-content pre code .variable.parameter.function{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .invalid.illegal{background:#b71c1c;background:var(--syntax-red);color:#f5f5f5;color:var(--syntax-background)}.post-content pre code .string{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .string.regexp{color:#006064;color:var(--syntax-cyan)}.post-content pre code .string.regexp .source.ruby.embedded{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .string.other.link{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .punctuation.definition.array,.post-content pre code .punctuation.definition.parameters{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .punctuation.definition.heading,.post-content pre code .punctuation.definition.identity{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .punctuation.definition.bold{color:#3e2723;color:var(--syntax-yellow);font-weight:700}.post-content pre code .punctuation.definition.italic{color:#4a148c;color:var(--syntax-purple);font-style:italic}.post-content pre code .punctuation.section.embedded{color:#3e2723;color:var(--syntax-brown)}.post-content pre code .punctuation.section.class,.post-content pre code .punctuation.section.inner-class,.post-content pre code .punctuation.section.method{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .support.class{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .support.function{color:#006064;color:var(--syntax-cyan)}.post-content pre code .support.function.any-method{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .entity.name.function{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .entity.name.class,.post-content pre code .entity.name.type.class{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .entity.name.section{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .entity.name.tag{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .entity.other.attribute-name{color:#e65100;color:var(--syntax-orange)}.post-content pre code .entity.other.attribute-name.id{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .meta.class{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .meta.class.body{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .meta.link{color:#e65100;color:var(--syntax-orange)}.post-content pre code .meta.method,.post-content pre code .meta.method-call{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .meta.require{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .meta.selector{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .meta.separator{background:#373b41;background:var(--syntax-separator);color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .meta.tag{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .none{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .markup.bold{color:#e65100;color:var(--syntax-orange);font-weight:700}.post-content pre code .markup.changed{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .markup.deleted{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .markup.italic{color:#4a148c;color:var(--syntax-purple);font-style:italic}.post-content pre code .markup.heading{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .markup.heading .punctuation.definition.heading{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .markup.link{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .markup.inserted{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .markup.quote{color:#e65100;color:var(--syntax-orange)}.post-content pre code .markup.raw{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .source.gfm .markup{-webkit-font-smoothing:auto}.post-content pre code .source.gfm .link .entity{color:#006064;color:var(--syntax-cyan)}.aspect-ratio{--aspect-ratio-w:1;--aspect-ratio-h:1;position:relative}.aspect-ratio>:first-child{width:100%}@supports (--custom-props:true){.aspect-ratio::before{display:block;padding-top:calc(var(--aspect-ratio-h,1)/ var(--aspect-ratio-w,1) * 100%);content:""}.aspect-ratio>:first-child{position:absolute;top:0;right:0;bottom:0;left:0;height:100%;width:100%}}.light-mode.light-mode,:root{--mdc-theme-primary:#009688;--primary-color:#009688;--primary-color-text:#009688;--page-background:#eceff1;--post-background:white;--text-color:rgba(0, 0, 0, 0.87);--code-color:#0D47A1;--faded-color:rgba(0, 0, 0, 0.6)}.dark-mode.dark-mode{--mdc-theme-primary:#00695C;--primary-color:#00695C;--primary-color-text:#80CBC4;--page-background:#212121;--post-background:#424242;--text-color:rgba(255, 255, 255, 0.9);--code-color:#BBDEFB;--faded-color:rgba(255, 255, 255, 0.6)}@media (prefers-color-scheme:dark){:root{--mdc-theme-primary:#00695C;--primary-color:#00695C;--primary-color-text:#80CBC4;--page-background:#212121;--post-background:#424242;--text-color:rgba(255, 255, 255, 0.9);--code-color:#BBDEFB;--faded-color:rgba(255, 255, 255, 0.6)}}body,html{display:flex;flex-direction:column;margin:0;padding:0;box-sizing:border-box;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-font-family,Rubik,sans-serif);height:100%;color:rgba(0,0,0,.87);color:var(--text-color);background:#eceff1;background:var(--page-background)}.site-content{flex-grow:1;background:#eceff1;background:var(--page-background);box-sizing:border-box}.mdc-button{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}
  
  </style>

  
</head>


  <body>

    <header class="header" role="banner">
<div>
  <a class="header-title" href="/">sgom.es</a>
</div>
</header>


    <main class="site-content" aria-label="Content">
        
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">So you want to use Redux (pt 1) — selectors</h1>
    <time class="post-meta" datetime="2018-12-06T13:10:00+00:00" itemprop="datePublished">(2018-12-06)</time>
  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>Hey folks!</p>
<p>Today I&#39;ll be focusing on a specific library, Redux, and the performance implications of using it. If your project doesn&#39;t depend on it and you&#39;re not planning on changing that, you can probably skip this, even though the categories of problems introduced aren&#39;t necessarily exclusive to Redux. Otherwise, read on!</p>
<h3 id="why-redux">Why Redux?</h3>
<p><em>My understanding of Redux is still limited, but I&#39;ll attempt a brief introduction throughout this post where I hope I won&#39;t make too many mistakes. If I do, please let me know on Twitter!</em></p>
<p>Redux and its associated tooling ecosystem came about as a way of isolating state for your application into a big immutable state tree of nested objects, which can be manipulated with a fair amount of abstraction and isolation.</p>
<p>Through interfacing libraries such as <code>react-redux</code>, components in your application can loosely couple to this tree by registering as being able to modify it, receive updates from it, or both. State is thus centralized, instead of explicitly or implicitly living inside the various components of your application.</p>
<p>As a core principle, state is not mutated, but rather replaced with a new copy when changes take place. Old and new can thus easily be compared by looking at the references rather than with deep comparisons.</p>
<p>When writing to the tree, modifications are performed through a set of actions, that get transformed into state tree changes via reducer functions. Each action can affect multiple reducers and hence multiple parts of the tree. For example, accepting a friendship invitation would both remove the invitation from the pending list as well as add a new entry to the friends list.</p>
<p>When reading from the tree, you have selector functions (a well-known pattern outside of Redux, too), which offer a simple and convenient way of returning a part of the state tree, or a chunk of data derived from one or multiple parts of the state tree. Through <code>react-redux</code> or similar libraries, components specify which selectors they need, and get props with the values returned by these selectors every time they change.</p>
<p>If you want more details, the <a href="https://redux.js.org/introduction/coreconcepts">Core Concepts page on the Redux documentation</a> is a good starting point.</p>
<p>It&#39;s a clever architecture, but it&#39;s not without its problems. Performance-wise, it comes with a number of ways you can accidentally shoot yourself in the foot.</p>
<h3 id="selectors">Selectors</h3>
<p>In this post we&#39;re going to be focusing on selectors.</p>
<p>As I mentioned before, selectors return a part of the state tree for your component to consume (or, alternatively, something derived from one or more parts the state tree). In a React world, this is done via the <code>connect</code> method from <code>react-redux</code> and looks something like this:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="meta import js"><span class="keyword control js"><span>import</span></span><span>&nbsp;</span><span class="punctuation definition modules begin js"><span>{</span></span><span>&nbsp;</span><span class="variable other module js"><span>connect</span></span><span>&nbsp;</span><span class="punctuation definition modules end js"><span>}</span></span><span>&nbsp;</span><span class="keyword control js"><span>from</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>react-redux</span><span class="punctuation definition string end js"><span>&#39;</span></span></span></span></span></div><div class="line"><span class="source js"><span>​</span></span></div><div class="line"><span class="source js"><span class="meta class js"><span class="storage type class js"><span>class</span></span><span>&nbsp;</span><span class="entity name type class js"><span>MyComponent</span></span><span>&nbsp;</span><span class="storage modifier js"><span>extends</span></span><span>&nbsp;</span><span class="entity other inherited-class js"><span>React</span></span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>Component</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace square js"><span>[</span></span><span class="keyword operator spread js"><span>...</span></span><span class="meta brace square js"><span>]</span></span></span></div><div class="line"><span class="source js"><span class="meta brace curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>ConnectedMyComponent</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>connect</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;mapStateToProps</span><span class="meta delimiter object comma js"><span>,</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;mapDispatchToProps</span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="meta brace round js"><span>(</span></span><span>MyComponent</span><span class="meta brace round js"><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>​</span></span></div><div class="line"><span class="source js"><span class="meta export js"><span class="keyword control js"><span>export</span></span><span>&nbsp;</span><span class="variable language default js"><span>default</span></span><span>&nbsp;</span><span class="variable other module js"><span>ConnectedMyComponent</span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div></code></pre>
<p><code>connect</code> takes two methods and uses them to produce a function that will wrap your component in a higher-order component that is connected to Redux. Phew.</p>
<p>The first method that <code>connect</code> takes, <code>mapStateToProps</code>, is where you get to return an object composed from the various selectors you need:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>mapStateToProps</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;color</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>getDefaultColor</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;language</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>getUserLanguage</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span></span></div></code></pre>
<p>As a result, your component gets the <code>color</code> and <code>language</code> props from the selectors you specified, and will automatically get new values for these props whenever the values returned by the selectors change. These selectors are nothing magical, though; they&#39;re plain pure JavaScript functions that simply return a part of the state tree:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>getDefaultColor</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>defaults</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="support variable property dom js"><span>color</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>getUserLanguage</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>loggedInUser</span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>?</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>loggedInUser</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>settings</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="support variable property dom js"><span>language</span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>:</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>defaults</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="support variable property dom js"><span>language</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span></span></div></code></pre>
<p>So if these are just plain functions and you&#39;re not explicitly declaring any dependency on any part of the state tree, how does the framework know when to send new props to your component? Well, it&#39;s very simple: <strong>it needs to run <em>every</em> selector registered to <em>every connected component instance</em> on <em>any change</em> to <em>any part</em> of the state tree</strong>.</p>
<p>Or actually even worse, in the case of <code>react-redux</code>: <strong>every time an action is dispatched, regardless of whether it produced any changes</strong>.</p>
<p>Making sure that doesn&#39;t cause performance problems can quickly get tricky, as I&#39;m sure you can imagine.</p>
<h3 id="problem-1-slow-selectors">Problem #1: slow selectors</h3>
<p>Performance is usually not a problem at all when your selectors are just picking an existing part of the state tree and sending it along. As in the examples above, you get an object reference, you return that object reference, and you&#39;re done.</p>
<p>But sometimes selectors are more complex than this and need to do something more expensive, such as transforming the data for serialization.</p>
<p>Now you have a problem not just with any component that uses this selector, but also with your application in general. Remember, every selector runs every time as long as a component instance is using it, so you&#39;re going to get that hit every time anything changes in your state tree. And you&#39;re going to be getting it as many times as you have component instances hooked up to it.</p>
<p>The fix is usually to add memoization, so that you only incur the expense once, provided things haven&#39;t changed. Defining the meaning of &quot;things haven&#39;t changed&quot; and validating it can be difficult, though; more on that later.</p>
<h3 id="problem-2-returning-new-references">Problem #2: returning new references</h3>
<p>Even if your selector is really fast at getting the data it needs, composing it together, and returning it, it may still be a source of inadvertent problems. Unless you&#39;ve come across this problem before (or read the title of this section), you might not see anything wrong with this code:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>getUserDefaults</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>userSettings</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>loggedInUser</span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>?</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>loggedInUserSettings</span><span>&nbsp;</span><span class="keyword operator ternary js"><span>:</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta brace square js"><span>[</span><span>]</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator spread js"><span>...</span></span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>defaults</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator spread js"><span>...</span></span><span>userSettings</span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span></span></div></code></pre>
<p>This just overrides the default settings with the user settings where available and returns the whole thing, right? Yes, that&#39;s exactly what it does, and it is very fast at doing it if the list of settings is small.</p>
<p>But it returns a new instance of that object every time. This instance gets passed as a prop to your React component, which, unless you&#39;ve taken special care, sees it as a change and triggers a render. So now every instance of every component that uses this selector is going to re-render every time anything changes in the state tree. That could be a problem.</p>
<p>The solution here is usually memoization too. Alternatives include moving the objects to state, so you can simply return the reference instead of computing it, or instead returning a primitive type (e.g. a string) where possible.</p>
<h3 id="problem-3-returning-new-references">Problem #3: returning new references</h3>
<p>No, that&#39;s not a typo, the same problem can occur elsewhere. Remember that <code>mapStateToProps</code> function? This bug can happen there too.</p>
<p>It&#39;s common (albeit likely inadvisable) to have code that looks something like this:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>mapStateToProps</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>someData</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>selector1</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>otherData</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>selector2</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>theDataINeed</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>combineDataSomehow</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>someData</span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;otherData</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span></span></div></code></pre>
<p>So now the onus is on <code>combineDataSomehow</code> to ensure that it doesn&#39;t generate a new reference every time. Here the impact of a mistake isn&#39;t quite as large, as it will only affect this particular component, but it will affect every instance of it.</p>
<p>The fix? You guessed it, memoization.</p>
<h3 id="so-about-that-memoization">So about that memoization</h3>
<p>A quick disclaimer before going any further: the first thing with any performance-related fixes is <strong>making sure you measure</strong>. Sure, you could theoretically be causing problems by not memoizing something that runs on every dispatch, but it&#39;s best to assume otherwise until proven.</p>
<p>As Donald Knuth put it:</p>
<blockquote>
<p><strong>Premature optimization is the root of all evil (or at least most of it) in programming</strong></p>
<p>Donald Knuth, Computer Programming as an Art (1974), among other sources</p>
</blockquote>
<p>Optimization usually leads to more complex code, and more complex code often leads to bugs. With memoization, the risk is that the cache doesn&#39;t get invalidated as often as it should and ends up returning stale data.</p>
<p>But let&#39;s assume for a second that there is in fact a problem and you&#39;ve traced it to a particular selector. Well, this doesn&#39;t seem like much of a problem at all. All you have to do is pull out <a href="https://lodash.com/docs/4.17.11#memoize"><code>memoize</code></a> from <a href="https://lodash.com"><code>lodash</code></a> and call it a day, right?</p>
<p>Maybe. But it&#39;s usually more complex than that. Let&#39;s go back to <code>getUserDefaults</code>. If you naively add memoization, what you get is the following:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>getUserDefaults</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>memoize</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span class="meta function arrow js"><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>userSettings</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>loggedInUser</span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>?</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>loggedInUserSettings</span><span>&nbsp;</span><span class="keyword operator ternary js"><span>:</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta brace square js"><span>[</span><span>]</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator spread js"><span>...</span></span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>defaults</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator spread js"><span>...</span></span><span>userSettings</span><span class="meta delimiter object comma js"><span>,</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div></code></pre>
<p>If you&#39;re following standard Redux rules and avoiding mutation, the <code>state</code> instance will be the same if nothing changes and will be different if something does. This means that if the state doesn&#39;t change, the memoized selector will return the same instance, solving the aforementioned problems. Great!</p>
<p>But is that really all we want? Right now if <strong>anything</strong> changes in the state, even if it&#39;s completely unrelated to what this selector cares about, you&#39;ll end up with a new instance and thus a new entry in the memoization cache. Besides making that grow to a potentially large size and keeping the previous states around for no good reason (since <code>memoize</code> uses a <code>Map</code>, not a <code>WeakMap</code>, by default), you&#39;re still only saving time if the state doesn&#39;t change very often, which is unlikely in a large interactive application.</p>
<p>If the goal is to have a large state tree with all aspects of the application&#39;s state in there, we need to be cleverer.</p>
<h3 id="a-library-for-the-library">A library for the library</h3>
<p>Enter <a href="https://github.com/reduxjs/reselect"><code>reselect</code></a>, <a href="https://github.com/aduth/rememo"><code>rememo</code></a>, <a href="https://github.com/Automattic/wp-calypso/blob/master/client/lib/create-selector/index.js"><code>wp-calypso</code>&#39;s <code>createSelector</code></a>, and friends. These are libraries that are specifically designed to help you with the task of creating memoized Redux selectors that try to strike that error-prone balance between invalidating your memoization cache too much (leading to unnecessary recomputation), and invalidating it too little (leading to stale data being returned).</p>
<p>So now you can depend on just the parts of the state tree that your selector cares about. In the case of <code>rememo</code> or <code>wp-calypso</code>&#39;s <code>createSelector</code>:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>getUserDefaults</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>createSelector</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="meta function arrow js"><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>userSettings</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>loggedInUser</span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>?</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>loggedInUserSettings</span><span>&nbsp;</span><span class="keyword operator ternary js"><span>:</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta brace square js"><span>[</span><span>]</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator spread js"><span>...</span></span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>defaults</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator spread js"><span>...</span></span><span>userSettings</span><span class="meta delimiter object comma js"><span>,</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="punctuation definition function body end bracket curly js"><span>}</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="meta function arrow js"><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="meta brace square js"><span>[</span></span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>loggedInUser</span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>defaults</span></span><span class="meta brace square js"><span>]</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div></code></pre>
<p>Now the selector is only invalidated if <code>state.loggedInUser</code> or <code>state.defaults</code> change. Even better, you could narrow it down to just the properties we care about inside those, but you would need to start adding some error checks.</p>
<h3 id="but-things-are-always-trickier-with-collections">But things are always trickier with collections</h3>
<p>For individual properties that you know exactly where to get, as in the examples above, things are straightforward. But very often you have arrays or other collections of objects and you have to find the item you want inside that structure.</p>
<p>Let&#39;s say a user has posts, and could have hundreds or thousands of them, but you want your selector to fetch a single one. Well, that&#39;s not a problem; since your selector is a plain JavaScript function, you can add a parameter. Ignoring error checking, this would look like:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>getUserPost</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="variable parameter function js"><span>postId</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>loggedInUser</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>posts</span></span><span class="meta brace square js"><span>[</span></span><span>postId</span><span class="meta brace square js"><span>]</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="entity name function js"><span>getUserPost</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="constant numeric decimal js"><span>12</span></span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div></code></pre>
<p>Great! But now how do we memoize this? We don&#39;t want to depend on every post, or otherwise every time any one of the posts changes your selector gets invalidated, even if it&#39;s for a different post:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>getUserPost</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>createSelector</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="meta function arrow js"><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="variable parameter function js"><span>postId</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>loggedInUser</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>posts</span></span><span class="meta brace square js"><span>[</span></span><span>postId</span><span class="meta brace square js"><span>]</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="punctuation definition function body end bracket curly js"><span>}</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="meta function arrow js"><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="meta brace square js"><span>[</span></span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>loggedInUser</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>posts</span></span><span class="meta brace square js"><span>]</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div></code></pre>
<p>Well, if you want to make this work correctly, you have to either use a library that supports parameters on the dependant function, or you have to write your own custom memoization. <code>wp-calypso</code>&#39;s <code>createSelector</code> does support parameters on the dependant function:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>getUserPost</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>createSelector</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="meta function arrow js"><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="variable parameter function js"><span>postId</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>loggedInUser</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>posts</span></span><span class="meta brace square js"><span>[</span></span><span>postId</span><span class="meta brace square js"><span>]</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="punctuation definition function body end bracket curly js"><span>}</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;</span><span class="meta function arrow js"><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="variable parameter function js"><span>state</span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="variable parameter function js"><span>postId</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="meta brace square js"><span>[</span></span><span class="variable other object js"><span>state</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>loggedInUser</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>posts</span></span><span class="meta brace square js"><span>[</span></span><span>postId</span><span class="meta brace square js"><span>]</span><span>]</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="meta arguments js"><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div></code></pre>
<p>But even then, this might not be doing what you expect! The cache is not per-<code>postId</code>, but still global; it only tracks <code>postId</code> to make sure it doesn&#39;t change, but if it does it still invalidates it.</p>
<p>As long as you&#39;re always asking for the same <code>postId</code>, everything will work great and you&#39;ll get memoized results when the post doesn&#39;t change in the state. But if you&#39;re alternating between two different IDs, you&#39;re going to be invalidating the cache every single time:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="meta function-call js"><span class="entity name function js"><span>getUserPost</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="constant numeric decimal js"><span>10</span></span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="entity name function js"><span>getUserPost</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="constant numeric decimal js"><span>20</span></span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="entity name function js"><span>getUserPost</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="constant numeric decimal js"><span>10</span></span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span><span>&nbsp;</span><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;Not&nbsp;cached,&nbsp;last&nbsp;one&nbsp;was&nbsp;20</span></span></span></div><div class="line"><span class="source js"><span class="meta function-call js"><span class="entity name function js"><span>getUserPost</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>state</span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="constant numeric decimal js"><span>20</span></span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span><span>&nbsp;</span><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;Not&nbsp;cached,&nbsp;last&nbsp;one&nbsp;was&nbsp;10</span></span></span></div></code></pre>
<p>For this, you&#39;d want to use something like <a href="https://www.npmjs.com/package/@automattic/tree-select"><code>wp-calypso</code>&#39;s <code>treeSelect</code></a>, which does keep track of the different branches in different caches. Or write your own error-prone custom memoization function that invalidates the cache every time it needs to, but only when it really needs to. Can&#39;t be that hard, right?</p>
<h3 id="next-steps">Next steps</h3>
<p>Alright, so once you understand all the intricacies of selectors, their potential performance implications, and how to memoize them if needed, you should be able to start writing nice and performant code for your Redux application. Great!</p>
<p>Only, not really... 😔 This is actually just the beginning. Redux still has a bunch of ways it can cause subtle and hard-to-find performance issues, and I&#39;ll be writing about them in one or more future articles.</p>
<p>In the meantime, let me know if I missed something on selectors, or if I got anything wrong here!</p>
<p><strong>And finally, huge thanks to Andrew Duthie and Jarda Snajdr for reviewing a draft of this post and suggesting some great changes!</strong></p>


  </div>

  <div class="post-tags">
      <span class="post-tags-head">Tags:&nbsp;</span>
      <div class="post-tags-list">
        
          redux
        
          react
        
          performance
        
          memoization
        
      </div>
  </div>
</article>

    </main>

    <footer class="footer">
  <div class="footer-contents">
    <img class="footer-avatar" src="/assets/images/avatar.jpg" alt="Author's avatar">

    <div class="footer-text">
      <h2 class="footer-heading">Hey there!</h2>
      <p class="footer-description">I’m Sérgio, and I work with Web frontend code. Sometimes I write about it here.</p>
    </div>

    <div class="footer-icons">
      <div class="footer-icons-row">
        <a href="https://twitter.com/sergiomdgomes" class="footer-bubble footer-twitter" aria-label="Author's Twitter page"></a>
        <a href="mailto:mail@sgom.es" class="footer-bubble footer-email" aria-label="Author's email address"></a>
      </div>
      <div class="footer-icons-row">
        <a href="/feed.xml" class="footer-bubble footer-feed" aria-label="Atom feed for this site"></a>
        <a href="https://github.com/sgomes" class="footer-bubble footer-github" aria-label="Author's GitHub profile'"></a>
      </div>
    </div>
  </div>
  <div class="footer-bottom">
    <div class="footer-copyright">Articles under
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons 4.0 Attribution</a>,
    code under <a rel="license" href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0</a>
    (unless otherwise indicated).</div>
  </div>
</footer>


    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(function(err) {
          console.log('Service worker registration failed: ', err);
        });
      }
    </script>

  </body>

</html>
