<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Supporting old browsers without hurting everyone</title>
  <meta name="description" content="I’m Sérgio, and I work with Web frontend code. Sometimes I write about it here.">

    <!--
      Hello, and welcome to the source for my site!
      There's not a lot to see around here, but I hope you get some inspiration/ideas/laughs.

      Here's an ASCII art stick figure saying hi:  o/
                                                  /|
                                                  / \

      Also, no, I'm not Spanish. I just like short domain names.
    -->

  <link rel="canonical" href="https://sgom.es/">
  <link rel="alternate" type="application/rss+xml" title="sgom.es" href="/feed.xml">

  <link rel="manifest" href="/manifest.json">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="sgom.es">
  <link rel="icon" sizes="16x16" href="/assets/images/touch/16x16.png">
  <link rel="icon" sizes="32x32" href="/assets/images/touch/32x32.png">
  <link rel="icon" sizes="192x192" href="/assets/images/touch/192x192.png">
  <link rel="icon" sizes="512x512" href="/assets/images/touch/512x512.png">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="sgom.es">
  <link rel="apple-touch-icon" href="/assets/images/touch/152x152.png">

  <meta name="msapplication-TileImage" content="/assets/images/touch/144x144.png">
  <meta name="msapplication-TileColor" content="#009688">

  <meta name="theme-color" content="#009688">

  <link rel="preconnect" href="https://fonts.gstatic.com">

  <style>
  
  @import url(https://fonts.googleapis.com/css?family=Roboto+Mono|Rubik:400,500&display=fallback);.header{display:flex;height:80px;background:#009688;background:var(--primary-color);color:#fff;justify-content:center;align-items:center;flex-shrink:0;z-index:2;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12)}.header-title{text-decoration:none;color:rgba(255,255,255,.9);-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline4-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:2.125rem;font-size:var(--mdc-typography-headline4-font-size,2.125rem);line-height:2.5rem;line-height:var(--mdc-typography-headline4-line-height,2.5rem);font-weight:400;font-weight:var(--mdc-typography-headline4-font-weight,400);letter-spacing:.0073529412em;letter-spacing:var(--mdc-typography-headline4-letter-spacing,.0073529412em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline4-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline4-text-transform,inherit);font-weight:700}.header-title:hover,.header-title:visited{color:rgba(255,255,255,.9)}.post{background:#fff;background:var(--post-background);padding:3.5rem 4.5rem;margin:0 auto;color:rgba(0,0,0,.87);color:var(--text-color);width:100%;max-width:45rem;box-sizing:border-box}@media screen and (max-width:600px){.post{padding:2rem 1rem}}.post-title{display:block;color:#009688;color:var(--primary-color-text);-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline4-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:2.125rem;font-size:var(--mdc-typography-headline4-font-size,2.125rem);line-height:2.5rem;line-height:var(--mdc-typography-headline4-line-height,2.5rem);font-weight:400;font-weight:var(--mdc-typography-headline4-font-weight,400);letter-spacing:.0073529412em;letter-spacing:var(--mdc-typography-headline4-letter-spacing,.0073529412em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline4-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline4-text-transform,inherit);margin-bottom:0;margin-top:0}.post-meta{display:block;color:#009688;color:var(--primary-color-text);-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-body2-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.875rem;font-size:var(--mdc-typography-body2-font-size,.875rem);line-height:1.25rem;line-height:var(--mdc-typography-body2-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-body2-font-weight,400);letter-spacing:.0178571429em;letter-spacing:var(--mdc-typography-body2-letter-spacing,.0178571429em);text-decoration:inherit;text-decoration:var(--mdc-typography-body2-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-body2-text-transform,inherit);margin-top:0}.post-image{max-width:100%;margin:0 auto}.post-image>img{display:block}.post-content{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-body1-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1rem;font-size:var(--mdc-typography-body1-font-size,1rem);line-height:1.5rem;line-height:var(--mdc-typography-body1-line-height,1.5rem);font-weight:400;font-weight:var(--mdc-typography-body1-font-weight,400);letter-spacing:.03125em;letter-spacing:var(--mdc-typography-body1-letter-spacing,.03125em);text-decoration:inherit;text-decoration:var(--mdc-typography-body1-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-body1-text-transform,inherit);font-size:1rem;letter-spacing:normal;box-sizing:border-box;margin:0}.post-content h1{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline5-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1.5rem;font-size:var(--mdc-typography-headline5-font-size,1.5rem);line-height:2rem;line-height:var(--mdc-typography-headline5-line-height,2rem);font-weight:400;font-weight:var(--mdc-typography-headline5-font-weight,400);letter-spacing:normal;letter-spacing:var(--mdc-typography-headline5-letter-spacing,normal);text-decoration:inherit;text-decoration:var(--mdc-typography-headline5-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline5-text-transform,inherit)}.post-content h2{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline6-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1.25rem;font-size:var(--mdc-typography-headline6-font-size,1.25rem);line-height:2rem;line-height:var(--mdc-typography-headline6-line-height,2rem);font-weight:500;font-weight:var(--mdc-typography-headline6-font-weight,500);letter-spacing:.0125em;letter-spacing:var(--mdc-typography-headline6-letter-spacing,.0125em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline6-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline6-text-transform,inherit);margin:0;margin-top:2rem}.post-content h2+h3{margin-top:1em}.post-content h3{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline6-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1.25rem;font-size:var(--mdc-typography-headline6-font-size,1.25rem);line-height:2rem;line-height:var(--mdc-typography-headline6-line-height,2rem);font-weight:500;font-weight:var(--mdc-typography-headline6-font-weight,500);letter-spacing:.0125em;letter-spacing:var(--mdc-typography-headline6-letter-spacing,.0125em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline6-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline6-text-transform,inherit);font-size:1.1rem;line-height:1.5rem;margin:2em 0 0}.post-content h4{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-body2-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.875rem;font-size:var(--mdc-typography-body2-font-size,.875rem);line-height:1.25rem;line-height:var(--mdc-typography-body2-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-body2-font-weight,400);letter-spacing:.0178571429em;letter-spacing:var(--mdc-typography-body2-letter-spacing,.0178571429em);text-decoration:inherit;text-decoration:var(--mdc-typography-body2-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-body2-text-transform,inherit);font-size:1rem;letter-spacing:normal;margin:2em 0 0;color:rgba(0,0,0,.6);color:var(--faded-color)}.post-content a{color:#009688;color:var(--primary-color-text);text-decoration-skip-ink:auto}.post-content a:hover,.post-content a:visited{color:#009688;color:var(--primary-color-text)}.post-content pre{border-radius:2px;margin:0;padding:16px;font-size:.9375em;font-style:normal;font-weight:400;letter-spacing:normal;line-height:normal;font-family:"Roboto Mono",monospace;overflow-x:auto}.post-content pre+pre{margin-top:16px}.post-content code{font-size:.9375em;color:#0d47a1;color:var(--code-color);font-family:"Roboto Mono",monospace}.post-content strong{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-body2-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.875rem;font-size:var(--mdc-typography-body2-font-size,.875rem);line-height:1.25rem;line-height:var(--mdc-typography-body2-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-body2-font-weight,400);letter-spacing:.0178571429em;letter-spacing:var(--mdc-typography-body2-letter-spacing,.0178571429em);text-decoration:inherit;text-decoration:var(--mdc-typography-body2-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-body2-text-transform,inherit);font-size:1rem;letter-spacing:normal}.post-content figure{max-width:100%;box-sizing:border-box;margin:0}.post-content figcaption{text-align:center;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-caption-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.75rem;font-size:var(--mdc-typography-caption-font-size,.75rem);line-height:1.25rem;line-height:var(--mdc-typography-caption-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-caption-font-weight,400);letter-spacing:.0333333333em;letter-spacing:var(--mdc-typography-caption-letter-spacing,.0333333333em);text-decoration:inherit;text-decoration:var(--mdc-typography-caption-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-caption-text-transform,inherit);margin:0}.post-content blockquote{margin:1.5em 0 2em 2.5em;border-left:1px solid #00bfa5;padding-left:1rem}.post-content table{display:block;margin:0 0 2rem;border-collapse:collapse;text-align:center;overflow-x:auto}.post-content table th{font-weight:500}.post-content table td,.post-content table th{padding:8px;border:1px solid #ddd}.post-content li+li{margin-top:.5rem}.post-content .overflow-x{overflow-x:auto}.post-tags{display:flex;align-items:baseline;flex-grow:1;line-height:normal;color:rgba(0,0,0,.6);color:var(--faded-color)}.post-tags-list{display:inline-block;flex-grow:1;margin-left:.2rem;font-family:"Roboto Mono",monospace;letter-spacing:normal}.footer{display:flex;flex-flow:column nowrap;width:100%;background:#009688;background:var(--primary-color);color:#fff;padding:16px;box-sizing:border-box;flex-shrink:0;z-index:2;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12)}.footer-contents{display:flex;position:relative;flex-flow:row nowrap;justify-content:center;align-items:center;margin:0 auto 0 auto;flex-shrink:0;box-sizing:border-box;padding:0 24px;width:100%;max-width:45rem}@media (max-width:600px){.footer-contents{flex-wrap:wrap;padding:0}}.footer-avatar{border-radius:10%;width:100px;height:100px;background:#000;flex-grow:0;flex-shrink:0;margin-right:16px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12)}.footer-text{flex-grow:1;flex-shrink:1;padding:16px;width:50%}.footer-heading{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-headline6-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:1.25rem;font-size:var(--mdc-typography-headline6-font-size,1.25rem);line-height:2rem;line-height:var(--mdc-typography-headline6-line-height,2rem);font-weight:500;font-weight:var(--mdc-typography-headline6-font-weight,500);letter-spacing:.0125em;letter-spacing:var(--mdc-typography-headline6-letter-spacing,.0125em);text-decoration:inherit;text-decoration:var(--mdc-typography-headline6-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-headline6-text-transform,inherit);margin-bottom:8px}.footer-description{margin:0}.footer-icons{display:block;flex-shrink:0;margin:.5rem 0}.footer-icons-row{display:block;flex-shrink:0}@media (max-width:600px){.footer-icons-row{display:inline-block}}.footer-bubble{display:inline-block;border-radius:50%;height:40px;width:40px;flex-shrink:0;margin:2px;background-repeat:no-repeat;background-size:contain;background-position:center}.footer-twitter{background-image:url(/assets/images/twitter.svg)}.footer-github{border-radius:0;background-image:url(/assets/images/github.svg)}.footer-email{background-image:url(/assets/images/email.svg)}.footer-feed{background-image:url(/assets/images/feed.svg)}.footer-bottom{display:flex;position:relative;justify-content:center;margin:8px auto 0 auto;flex-shrink:0;width:100%;max-width:45rem}.footer-bottom::before{display:block;position:absolute;top:50%;width:100%;height:1px;background:rgba(255,255,255,.17);content:""}.footer-copyright{display:inline-block;text-align:center;background:#009688;background:var(--primary-color);z-index:2;padding:0 8px;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-caption-font-family,var(--mdc-typography-font-family,Rubik,sans-serif));font-size:.75rem;font-size:var(--mdc-typography-caption-font-size,.75rem);line-height:1.25rem;line-height:var(--mdc-typography-caption-line-height,1.25rem);font-weight:400;font-weight:var(--mdc-typography-caption-font-weight,400);letter-spacing:.0333333333em;letter-spacing:var(--mdc-typography-caption-letter-spacing,.0333333333em);text-decoration:inherit;text-decoration:var(--mdc-typography-caption-text-decoration,inherit);text-transform:inherit;text-transform:var(--mdc-typography-caption-text-transform,inherit);margin:0}.footer-copyright a{color:rgba(255,255,255,.9);text-decoration:none;font-weight:700}.footer-copyright a:hover,.footer-copyright a:visited{color:rgba(255,255,255,.9)}.light-mode.light-mode,:root{--syntax-red:#B71C1C;--syntax-orange:#E65100;--syntax-green:#1B5E20;--syntax-cyan:#006064;--syntax-blue:#0D47A1;--syntax-purple:#4A148C;--syntax-brown:#3E2723;--syntax-yellow:#3E2723;--syntax-gray:#616161;--syntax-text:rgba(0, 0, 0, 0.87);--syntax-separator:#373B41;--syntax-background:#F5F5F5}@media (prefers-color-scheme:dark){:root{--syntax-red:#EF9A9A;--syntax-orange:#FFCC80;--syntax-green:#A5D6A7;--syntax-cyan:#80DEEA;--syntax-blue:#90CAF9;--syntax-purple:#CE93D8;--syntax-brown:#BCAAA4;--syntax-yellow:#FFF59D;--syntax-gray:#BDBDBD;--syntax-text:#F5F5F5;--syntax-separator:#BFCDE3;--syntax-background:#212121}}.dark-mode.dark-mode{--syntax-red:#EF9A9A;--syntax-orange:#FFCC80;--syntax-green:#A5D6A7;--syntax-cyan:#80DEEA;--syntax-blue:#90CAF9;--syntax-purple:#CE93D8;--syntax-brown:#BCAAA4;--syntax-yellow:#FFF59D;--syntax-gray:#BDBDBD;--syntax-text:#F5F5F5;--syntax-separator:#BFCDE3;--syntax-background:#212121}.post-content pre{background:#f5f5f5;background:var(--syntax-background)}.post-content pre code{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .comment{color:#616161;color:var(--syntax-gray)}.post-content pre code .comment .markup.link{color:#616161;color:var(--syntax-gray)}.post-content pre code .entity.name.type{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .entity.other.inherited-class{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .keyword{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .keyword.control{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .keyword.operator{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .keyword.other.special-method{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .keyword.other.unit{color:#e65100;color:var(--syntax-orange)}.post-content pre code .storage{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .constant{color:#e65100;color:var(--syntax-orange)}.post-content pre code .constant.character.escape{color:#006064;color:var(--syntax-cyan)}.post-content pre code .constant.numeric{color:#e65100;color:var(--syntax-orange)}.post-content pre code .constant.other.color{color:#006064;color:var(--syntax-cyan)}.post-content pre code .constant.other.symbol{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .variable{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .variable.interpolation{color:#3e2723;color:var(--syntax-brown)}.post-content pre code .variable.parameter.function{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .invalid.illegal{background:#b71c1c;background:var(--syntax-red);color:#f5f5f5;color:var(--syntax-background)}.post-content pre code .string{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .string.regexp{color:#006064;color:var(--syntax-cyan)}.post-content pre code .string.regexp .source.ruby.embedded{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .string.other.link{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .punctuation.definition.array,.post-content pre code .punctuation.definition.parameters{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .punctuation.definition.heading,.post-content pre code .punctuation.definition.identity{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .punctuation.definition.bold{color:#3e2723;color:var(--syntax-yellow);font-weight:700}.post-content pre code .punctuation.definition.italic{color:#4a148c;color:var(--syntax-purple);font-style:italic}.post-content pre code .punctuation.section.embedded{color:#3e2723;color:var(--syntax-brown)}.post-content pre code .punctuation.section.class,.post-content pre code .punctuation.section.inner-class,.post-content pre code .punctuation.section.method{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .support.class{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .support.function{color:#006064;color:var(--syntax-cyan)}.post-content pre code .support.function.any-method{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .entity.name.function{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .entity.name.class,.post-content pre code .entity.name.type.class{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .entity.name.section{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .entity.name.tag{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .entity.other.attribute-name{color:#e65100;color:var(--syntax-orange)}.post-content pre code .entity.other.attribute-name.id{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .meta.class{color:#3e2723;color:var(--syntax-yellow)}.post-content pre code .meta.class.body{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .meta.link{color:#e65100;color:var(--syntax-orange)}.post-content pre code .meta.method,.post-content pre code .meta.method-call{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .meta.require{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .meta.selector{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .meta.separator{background:#373b41;background:var(--syntax-separator);color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .meta.tag{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .none{color:rgba(0,0,0,.87);color:var(--syntax-text)}.post-content pre code .markup.bold{color:#e65100;color:var(--syntax-orange);font-weight:700}.post-content pre code .markup.changed{color:#4a148c;color:var(--syntax-purple)}.post-content pre code .markup.deleted{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .markup.italic{color:#4a148c;color:var(--syntax-purple);font-style:italic}.post-content pre code .markup.heading{color:#b71c1c;color:var(--syntax-red)}.post-content pre code .markup.heading .punctuation.definition.heading{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .markup.link{color:#0d47a1;color:var(--syntax-blue)}.post-content pre code .markup.inserted{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .markup.quote{color:#e65100;color:var(--syntax-orange)}.post-content pre code .markup.raw{color:#1b5e20;color:var(--syntax-green)}.post-content pre code .source.gfm .markup{-webkit-font-smoothing:auto}.post-content pre code .source.gfm .link .entity{color:#006064;color:var(--syntax-cyan)}.aspect-ratio{--aspect-ratio-w:1;--aspect-ratio-h:1;position:relative}.aspect-ratio>:first-child{width:100%}@supports (--custom-props:true){.aspect-ratio::before{display:block;padding-top:calc(var(--aspect-ratio-h,1)/ var(--aspect-ratio-w,1) * 100%);content:""}.aspect-ratio>:first-child{position:absolute;top:0;right:0;bottom:0;left:0;height:100%;width:100%}}.light-mode.light-mode,:root{--mdc-theme-primary:#009688;--primary-color:#009688;--primary-color-text:#009688;--page-background:#eceff1;--post-background:white;--text-color:rgba(0, 0, 0, 0.87);--code-color:#0D47A1;--faded-color:rgba(0, 0, 0, 0.6)}.dark-mode.dark-mode{--mdc-theme-primary:#00695C;--primary-color:#00695C;--primary-color-text:#80CBC4;--page-background:#212121;--post-background:#424242;--text-color:rgba(255, 255, 255, 0.9);--code-color:#BBDEFB;--faded-color:rgba(255, 255, 255, 0.6)}@media (prefers-color-scheme:dark){:root{--mdc-theme-primary:#00695C;--primary-color:#00695C;--primary-color-text:#80CBC4;--page-background:#212121;--post-background:#424242;--text-color:rgba(255, 255, 255, 0.9);--code-color:#BBDEFB;--faded-color:rgba(255, 255, 255, 0.6)}}body,html{display:flex;flex-direction:column;margin:0;padding:0;box-sizing:border-box;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:Rubik,sans-serif;font-family:var(--mdc-typography-font-family,Rubik,sans-serif);height:100%;color:rgba(0,0,0,.87);color:var(--text-color);background:#eceff1;background:var(--page-background)}.site-content{flex-grow:1;background:#eceff1;background:var(--page-background);box-sizing:border-box}.mdc-button{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}
  
  </style>

  
</head>


  <body>

    <header class="header" role="banner">
<div>
  <a class="header-title" href="/">sgom.es</a>
</div>
</header>


    <main class="site-content" aria-label="Content">
        
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Supporting old browsers without hurting everyone</h1>
    <time class="post-meta" datetime="2019-03-06T11:00:00+00:00" itemprop="datePublished">(2019-03-06)</time>
  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>Many of us work in JS-heavy projects that need to support old browsers which are no longer maintained. As new features are released into the web platform, both as new syntax and as new APIs, old browsers get further and further away from modern ones simply by standing still.</p>
<p>Of course, as developers, we want to be able to take advantage of the new features, instead of sticking to the lowest common denominator in our code. So we write modern code and rely on two sets of tools to convert it into that lowest common denominator: build-time syntax transformation (with tools such as <a href="https://babeljs.io/"><code>Babel</code></a>) and run-time libraries that patch over missing functionality (<a href="https://en.wikipedia.org/wiki/Polyfill_(programming)">polyfills</a> and <a href="https://github.com/sindresorhus/ponyfill">ponyfills</a>).</p>
<h2 id="the-cost-of-support">The cost of support</h2>
<p>Neither of these come for free, however. Run-time libraries have an obvious cost in that they’re plain JS that needs to be sent over to the user so that their browser can do what it doesn’t natively support. Syntax transformations have a cost too, in that they often lead to more verbose code, and they often rely on features (such as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator">generators</a>) that need to be implemented as run-time libraries.</p>
<p>Where run-time support is concerned, <a href="https://www.npmjs.com/package/core-js"><code>core-js</code></a> alone often accounts for over 30KB after minification and compression. That’s 30KB going over the wire, and 140KB being parsed, compiled, and partially executed by the end-user’s browser (which, in a mobile device with a slow CPU, can take a long time). Syntax transformations can add a non-trivial amount of bytes too, depending on the size of your codebase.</p>
<p>And importantly, much of this is often code that needs to run before any other JS, leading to an increased time-to-interactive and an overall worse experience.</p>
<p>For old browsers, this is unavoidable; they need to run that code, after all! But for modern browsers, that’s extra cruft that will never be needed. So how can we avoid sending it to those users?</p>
<h2 id="multiple-build-targets">Multiple build targets</h2>
<p>If this were less fundamental code, such as a polyfill for a particular web feature that you only use here and there, you might be able to get away with a dynamic-loading strategy where you make your code asynchronous and determine, at run-time, whether you need to load extra JS before running it.</p>
<p>That’s a good, fine-grained approach, but for the purposes of this article we’ll assume that it’s impractical to apply to your entire codebase, and go with a simpler (albeit blunter) solution: multiple build targets.</p>
<p>The idea is straightforward: instead of having a single version of your JS files that you send to everyone, you instead have a version that you send to modern browsers, and a different, fallback version that you send to everyone else.</p>
<p><strong>The approach I’m about to lay out isn’t new, nor is it necessarily the best one for your scenario.</strong> However, it is relatively incremental and simple, and works with any other optimisations you’re already doing (such as code splitting). If nothing else, it may give you some ideas for your own approach!</p>
<p>As a bonus, it works with CSS too, if you’re doing <a href="https://www.npmjs.com/package/autoprefixer">autoprefixing</a>; dropping prefixes for old browsers will save some bytes as well.</p>
<p>Also, for the sake of conciseness, I’ll assume that you’re using <code>npm</code> scripts and <code>WebPack</code>, but this approach should still work with similar tools, with the right configuration.</p>
<h2 id="step-1-set-up-your-browserslist">Step 1: set up your <code>browserslist</code></h2>
<p>Many of the tools commonly run in our build processes nowadays use <a href="https://www.npmjs.com/package/browserslist"><code>browserslist</code></a>, a library that makes it easy to define a set of supported browsers and have everything configure itself in order to support them. You’ve probably added something like this to your <code>package.json</code>:</p>
<pre><code class="language-json"><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json"><span>{</span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span>&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>browserslist</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json"><span>:</span></span><span>&nbsp;</span><span class="meta structure array json"><span class="punctuation definition array begin json"><span>[</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>Safari&nbsp;&gt;=&nbsp;10</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>iOS&nbsp;&gt;=&nbsp;10</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>not&nbsp;ie&nbsp;&lt;=&nbsp;10</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>&gt;&nbsp;1%</span><span class="punctuation definition string end json"><span>&quot;</span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;</span><span class="punctuation definition array end json"><span>]</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary end json"><span>}</span></span></span></span></div></code></pre>
<p>One excellent feature of <code>browserslist</code> is that it actually supports multiple configurations, which it calls &quot;environments&quot;. This means you could write:</p>
<pre><code class="language-json"><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json"><span>{</span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span>&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>browserslist</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json"><span>:</span></span><span>&nbsp;</span><span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json"><span>{</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>defaults</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json"><span>:</span></span><span>&nbsp;</span><span class="meta structure array json"><span class="punctuation definition array begin json"><span>[</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>Safari&nbsp;&gt;=&nbsp;10</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>iOS&nbsp;&gt;=&nbsp;10</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>not&nbsp;ie&nbsp;&lt;=&nbsp;10</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>&gt;&nbsp;1%</span><span class="punctuation definition string end json"><span>&quot;</span></span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition array end json"><span>]</span></span></span><span class="punctuation separator dictionary pair json"><span>,</span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>evergreen</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json"><span>:</span></span><span>&nbsp;</span><span class="meta structure array json"><span class="punctuation definition array begin json"><span>[</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;Chrome&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;ChromeAndroid&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;Firefox&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;FirefoxAndroid&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;Safari&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;iOS&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;Edge&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator array json"><span>,</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>last&nbsp;2&nbsp;Opera&nbsp;versions</span><span class="punctuation definition string end json"><span>&quot;</span></span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure array json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition array end json"><span>]</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span>&nbsp;&nbsp;</span></span><span class="punctuation definition dictionary end json"><span>}</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary end json"><span>}</span></span></span></span></div></code></pre>
<p>You now have a definition of what each target means, which you’ll make use of later. <code>defaults</code> will get used by default, by the way, so making this particular change shouldn’t break anything in your application.</p>
<p>Do make sure that all of your build tools are using this configuration, however. You may find that you have different lists defined elsewhere, such as in your <code>.babelrc</code> or your <code>WebPack</code> config, which you will need to remove so that the tools fall back to what’s in your <code>package.json</code>.</p>
<p>For <code>Babel</code>, make sure that you’re using <a href="https://babeljs.io/docs/en/babel-preset-env">the <code>env</code> preset</a> instead of an explicit set of transforms, otherwise it’ll ignore your <code>browserslist</code> configuration.</p>
<h2 id="step-2-handle-tools-that-dont-support-browserslist">Step 2: handle tools that don’t support <code>browserslist</code></h2>
<p>Unfortunately, not everything supports <code>browserslist</code>. One example of this is <a href="https://www.npmjs.com/package/terser"><code>Terser</code></a>, a JS minifier that can handle the newer JS syntax.</p>
<p>For tools like this, you have two choices: either you swap them for a tool that does understand <code>browserslist</code>, or you write some custom code that provides a configuration based on <code>browserslist</code>.</p>
<p>An overly simplified but usable approach for <code>Terser</code> would be to modify your <code>WebPack</code> configuration like this:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>browserslist</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="support function js"><span>require</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>browserslist</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>caniuse</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="support function js"><span>require</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>caniuse-api</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>TerserPlugin</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="support function js"><span>require</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>terser-webpack-plugin</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;We&#39;ll&nbsp;look&nbsp;at&nbsp;this&nbsp;in&nbsp;the&nbsp;next&nbsp;step.</span></span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>env</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="support variable js"><span>process</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>env</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="constant other property js"><span>BROWSERSLIST_ENV</span></span><span>&nbsp;</span><span class="keyword operator logical js"><span>||</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>defaults</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>supportedBrowsers</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>browserslist</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="constant language null js"><span>null</span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span><span>&nbsp;env&nbsp;</span><span class="meta brace curly js"><span>}</span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>chooseTerserEcmaVersion</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="variable parameter function js"><span>browsers</span></span><span>&nbsp;</span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>if</span></span><span>&nbsp;</span><span class="meta brace round js"><span>(</span></span><span>&nbsp;</span><span class="keyword operator logical js"><span>!</span></span><span>&nbsp;</span><span class="variable other object js"><span>caniuse</span></span><span class="meta method-call js"><span class="meta delimiter method period js"><span>.</span></span><span class="entity name function js"><span>isSupported</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>arrow-functions</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;browsers&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="meta brace round js"><span>)</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="constant numeric decimal js"><span>5</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>if</span></span><span>&nbsp;</span><span class="meta brace round js"><span>(</span></span><span>&nbsp;</span><span class="keyword operator logical js"><span>!</span></span><span>&nbsp;</span><span class="variable other object js"><span>caniuse</span></span><span class="meta method-call js"><span class="meta delimiter method period js"><span>.</span></span><span class="entity name function js"><span>isSupported</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>es6-class</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;browsers&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="meta brace round js"><span>)</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="constant numeric decimal js"><span>5</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="constant numeric decimal js"><span>6</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>webpackConfig</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace square js"><span>[</span></span><span class="keyword operator spread js"><span>...</span></span><span class="meta brace square js"><span>]</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;minimizer</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="meta brace square js"><span>[</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta class instance constructor js"><span class="keyword operator new js"><span>new</span></span><span>&nbsp;</span><span class="entity name type instance js"><span>TerserPlugin</span></span></span><span class="meta brace round js"><span>(</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;terserOptions</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecma</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>chooseTerserEcmaVersion</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;supportedBrowsers&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;safari10</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="variable other object js"><span>supportedBrowsers</span></span><span class="meta method-call js"><span class="meta delimiter method period js"><span>.</span></span><span class="entity name function js"><span>some</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta method-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function arrow js"><span class="meta parameters js"><span class="variable parameter function js"><span>browser</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="variable other object js"><span>browser</span></span><span class="meta method-call js"><span class="meta delimiter method period js"><span>.</span></span><span class="entity name function js"><span>includes</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>safari&nbsp;10</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="keyword operator logical js"><span>||</span></span></span></span></span></div><div class="line"><span class="source js"><span class="meta method-call js"><span class="meta arguments js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object js"><span>browser</span></span><span class="meta method-call js"><span class="meta delimiter method period js"><span>.</span></span><span class="entity name function js"><span>includes</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>ios_saf&nbsp;10</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;You&nbsp;can&nbsp;compute&nbsp;this&nbsp;too&nbsp;if&nbsp;you&nbsp;really&nbsp;have&nbsp;to.</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ie8</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="constant language boolean false js"><span>false</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span><span>&nbsp;</span><span class="meta brace round js"><span>)</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace square js"><span>]</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span class="meta brace curly js"><span>}</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="support variable js"><span>module</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>exports</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;webpackConfig</span><span class="punctuation terminator statement js"><span>;</span></span></span></div></code></pre>
<p>You’ll need a deep understanding of the tool and its configuration to make this work well, and you’ll probably need to revisit and update your code as new versions come out. The best long-term approach is really to file an issue with the tool requesting <code>browserslist</code> support, or to contribute that work yourself, if you’ve got the chance.</p>
<h2 id="step-3-environment-variables">Step 3: environment variables</h2>
<p>The easiest way of choosing which <code>browserslist</code> environment to use is through the <code>BROWSERSLIST_ENV</code> environment variable. If you’re using npm scripts, it could end up looking something like this:</p>
<pre><code class="language-json"><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json"><span>{</span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span>&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>scripts</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json"><span>:</span></span><span>&nbsp;</span><span class="meta structure dictionary json"><span class="punctuation definition dictionary begin json"><span>{</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>build</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json"><span>:</span></span><span>&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>npm&nbsp;run&nbsp;build:fallback&nbsp;&amp;&amp;&nbsp;npm&nbsp;run&nbsp;build:evergreen</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator dictionary pair json"><span>,</span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>build:fallback</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json"><span>:</span></span><span>&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>BROWSERSLIST_ENV=defaults&nbsp;webpack</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="punctuation separator dictionary pair json"><span>,</span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>build:evergreen</span><span class="punctuation definition string end json"><span>&quot;</span></span></span><span class="meta structure dictionary value json"><span class="punctuation separator dictionary key-value json"><span>:</span></span><span>&nbsp;</span><span class="string quoted double json"><span class="punctuation definition string begin json"><span>&quot;</span></span><span>BROWSERSLIST_ENV=evergreen&nbsp;webpack</span><span class="punctuation definition string end json"><span>&quot;</span></span></span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span class="meta structure dictionary json"><span class="meta structure dictionary value json"><span>&nbsp;&nbsp;</span></span><span class="punctuation definition dictionary end json"><span>}</span></span></span></span></span></span></div><div class="line"><span class="source json"><span class="meta structure dictionary json"><span class="punctuation definition dictionary end json"><span>}</span></span></span></span></div></code></pre>
<p>You could even use something like <a href="https://www.npmjs.com/package/concurrently"><code>concurrently</code></a> to make them run in parallel, which could help with build times.</p>
<p>Handling things at the <code>npm</code> script level allows you to keep your <code>WebPack</code> configuration simple, with only some small changes to support both builds. And even if your <code>build</code> scripts are using other tools outside of <code>WebPack</code> as part of the process, they’ll still pick up the environment variable and adjust their output, as long as they support <code>browserslist</code>.</p>
<h2 id="step-4-configure-build-paths-in-webpack">Step 4: configure build paths in WebPack</h2>
<p>Since the goal is to have multiple targets, we’ll need to make sure that they actually get output to different paths and don’t just end up rewriting each other.</p>
<p>This involves some tweaks to your <code>WebPack</code> configuration, e.g.:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>env</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="support variable js"><span>process</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other object property js"><span>env</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="constant other property js"><span>BROWSERSLIST_ENV</span></span><span>&nbsp;</span><span class="keyword operator logical js"><span>||</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>defaults</span><span class="punctuation definition string end js"><span>&#39;</span></span></span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>extraPath</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;env&nbsp;</span><span class="keyword operator comparison js"><span>===</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>defaults</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>?</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>fallback</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>:</span></span><span>&nbsp;env</span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>webpackConfig</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace square js"><span>[</span></span><span class="keyword operator spread js"><span>...</span></span><span class="meta brace square js"><span>]</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;output</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;path</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="variable other object js"><span>path</span></span><span class="meta method-call js"><span class="meta delimiter method period js"><span>.</span></span><span class="support function js"><span>join</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="support variable js"><span>__dirname</span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>public</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;extraPath&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;publicPath</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="string quoted template js"><span class="punctuation definition string begin js"><span>`</span></span><span>/</span><span class="source js embedded source"><span class="punctuation section embedded js"><span>${</span></span><span>&nbsp;extraPath&nbsp;</span><span class="punctuation section embedded js"><span>}</span></span></span><span>/</span><span class="punctuation definition string end js"><span>`</span></span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span class="meta brace curly js"><span>}</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="support variable js"><span>module</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="variable other property js"><span>exports</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;webpackConfig</span><span class="punctuation terminator statement js"><span>;</span></span></span></div></code></pre>
<p>This reads the <code>BROWSERSLIST_ENV</code> environment variable to figure out which build it’s working on, and saves the build files to either <code>public/fallback</code> or <code>public/evergreen</code>, accordingly.</p>
<h2 id="step-5-choose-which-build-to-serve">Step 5: choose which build to serve</h2>
<p>Now that we have two builds in place, we need to decide which one to provide to users when serving the page.</p>
<p>For <code>Node</code>-based environments, we can easily make use of <code>browserslist</code> here as well, through <a href="https://www.npmjs.com/package/browserslist-useragent"><code>browserslist-useragent</code></a>. This library allows you to check whether a specific browser (as defined by its user agent string) is supported by your <code>browserslist</code> configuration.</p>
<p>We can therefore use it to see if the user’s browser is supported by the evergreen build, and serve that if so, falling back to the fallback one otherwise. This will of course be heavily dependent on your server-side code, but the basic gist of it is:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="meta import js"><span class="keyword control js"><span>import</span></span><span>&nbsp;</span><span class="punctuation definition modules begin js"><span>{</span></span><span>&nbsp;</span><span class="variable other module js"><span>matchesUA</span></span><span>&nbsp;</span><span class="punctuation definition modules end js"><span>}</span></span><span>&nbsp;</span><span class="keyword control js"><span>from</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>browserslist-useragent</span><span class="punctuation definition string end js"><span>&#39;</span></span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="meta function js"><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>getAssetPath</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="variable parameter function js"><span>userAgentString</span></span><span>&nbsp;</span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>options</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;env</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>evergreen</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;Try&nbsp;to&nbsp;get&nbsp;newer&nbsp;versions&nbsp;to&nbsp;match,&nbsp;too.</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;ignorePatch</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="constant language boolean true js"><span>true</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;ignoreMinor</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="constant language boolean true js"><span>true</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;allowHigherVersions</span><span class="keyword operator assignment js"><span>:</span></span><span>&nbsp;</span><span class="constant language boolean true js"><span>true</span></span><span class="meta delimiter object comma js"><span>,</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>if</span></span><span>&nbsp;</span><span class="meta brace round js"><span>(</span></span><span>&nbsp;</span><span class="meta function-call js"><span class="entity name function js"><span>matchesUA</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;userAgentString</span><span class="meta delimiter object comma js"><span>,</span></span><span>&nbsp;options&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="meta brace round js"><span>)</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>evergreen/</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="keyword control js"><span>return</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>fallback/</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span></span></div></code></pre>
<h2 id="step-6-fix-newer-syntax-bugs">Step 6: fix newer syntax bugs</h2>
<p>Now that you can have an evergreen version you can run, you’re possibly going to find it comes with a few bugs. These are bugs that <strong>were already present in your source code</strong>, but never got a chance to actually run when that source was being transformed into older syntax.</p>
<p>One example of this is using an arrow function as a constructor:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>Foo</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta function arrow js"><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span><span>&nbsp;</span><span class="storage type function arrow js"><span>=&gt;</span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;Some&nbsp;code&nbsp;goes&nbsp;here.</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="storage type const js"><span>const</span></span><span>&nbsp;</span><span class="constant other js"><span>foo</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta class instance constructor js"><span class="keyword operator new js"><span>new</span></span><span>&nbsp;</span><span class="entity name type instance js"><span>Foo</span></span></span><span class="meta brace round js"><span>(</span><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;=&gt;&nbsp;Uncaught&nbsp;TypeError:&nbsp;Foo&nbsp;is&nbsp;not&nbsp;a&nbsp;constructor</span></span></span></div></code></pre>
<p>This is an error, and comes up as such in the evergreen build. But in the fallback build, where arrow functions get transpiled into regular functions, that’s not a problem:</p>
<pre><code class="language-js"><div class="line"><span class="source js"><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;An&nbsp;approximation&nbsp;of&nbsp;what&nbsp;Babel&nbsp;outputs</span></span></span></div><div class="line"><span class="source js"><span class="storage type var js"><span>var</span></span><span>&nbsp;</span><span class="meta function js"><span class="entity name function js"><span>Foo</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="storage type function js"><span>function</span></span><span>&nbsp;</span><span class="entity name function js"><span>Foo</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;&nbsp;</span><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;Some&nbsp;code&nbsp;goes&nbsp;here.</span></span></span></div><div class="line"><span class="source js"><span class="punctuation definition function body end bracket curly js"><span>}</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span>&nbsp;</span></span></div><div class="line"><span class="source js"><span class="storage type var js"><span>var</span></span><span>&nbsp;foo&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="meta class instance constructor js"><span class="keyword operator new js"><span>new</span></span><span>&nbsp;</span><span class="entity name type instance js"><span>Foo</span></span></span><span class="meta brace round js"><span>(</span><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></div><div class="line"><span class="source js"><span class="comment line double-slash js"><span class="punctuation definition comment js"><span>//</span></span><span>&nbsp;=&gt;&nbsp;No&nbsp;errors</span></span></span></div></code></pre>
<p>Another category of issues you may run into comes from differences in scoping rules between <code>const</code> / <code>let</code> and <code>var</code>.</p>
<h2 id="step-7-optional-safeguards">Step 7 (optional): safeguards</h2>
<p>We’re now serving the evergreen build to browsers that are part of a well-defined approved list, based on the user agent string that they provide. Everyone else gets the fallback build which, although slower, should work for all of the supported browsers.</p>
<p>That said, it is conceivable that an old browser would misreport its user agent string to impersonate a newer browser. Depending on how you want to handle that situation, you could add a safeguard to the evergreen version of your site which would do a quick litmus test to guarantee that evergreen functionality is indeed supported.</p>
<pre><code class="language-html"><div class="line"><span class="text html basic"><span class="source js embedded html"><span class="punctuation definition tag html"><span>&lt;</span></span><span class="entity name tag script html"><span>script</span></span><span>&nbsp;</span><span class="entity other attribute-name html"><span>nomodule</span></span><span class="punctuation definition tag html"><span>&gt;</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span>&nbsp;&nbsp;</span><span class="meta brace round js"><span>(</span></span><span class="meta function js"><span class="storage type function js"><span>function</span></span><span class="meta parameters js"><span class="punctuation definition parameters begin bracket round js"><span>(</span></span><span class="punctuation definition parameters end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="punctuation definition function body begin bracket curly js"><span>{</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type var js"><span>var</span></span><span>&nbsp;url&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;</span><span class="support variable dom js"><span>window</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="support variable property dom js"><span>location</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="support variable property dom js"><span>href</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control js"><span>if</span></span><span>&nbsp;</span><span class="meta brace round js"><span>(</span></span><span>&nbsp;</span><span class="variable other object js"><span>url</span></span><span class="meta method-call js"><span class="meta delimiter method period js"><span>.</span></span><span class="support function js"><span>indexOf</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>forceFallback=1</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="keyword operator comparison js"><span>===</span></span><span>&nbsp;</span><span class="keyword operator js"><span>-</span></span><span class="constant numeric decimal js"><span>1</span></span><span>&nbsp;</span><span class="meta brace round js"><span>)</span></span><span>&nbsp;</span><span class="meta brace curly js"><span>{</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;</span><span class="keyword operator assignment compound js"><span>+=</span></span><span>&nbsp;</span><span class="meta brace round js"><span>(</span></span><span>&nbsp;</span><span class="variable other object js"><span>url</span></span><span class="meta method-call js"><span class="meta delimiter method period js"><span>.</span></span><span class="support function js"><span>indexOf</span></span><span class="meta arguments js"><span class="punctuation definition arguments begin bracket round js"><span>(</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>?</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="punctuation definition arguments end bracket round js"><span>)</span></span></span></span><span>&nbsp;</span><span class="keyword operator comparison js"><span>!==</span></span><span>&nbsp;</span><span class="keyword operator js"><span>-</span></span><span class="constant numeric decimal js"><span>1</span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>?</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>&amp;</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="keyword operator ternary js"><span>:</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>?</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span>&nbsp;</span><span class="meta brace round js"><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;</span><span class="keyword operator assignment compound js"><span>+=</span></span><span>&nbsp;</span><span class="string quoted single js"><span class="punctuation definition string begin js"><span>&#39;</span></span><span>forceFallback=1</span><span class="punctuation definition string end js"><span>&#39;</span></span></span><span class="punctuation terminator statement js"><span>;</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support variable dom js"><span>window</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="support variable property dom js"><span>location</span></span><span class="meta delimiter property period js"><span>.</span></span><span class="support variable property dom js"><span>href</span></span><span>&nbsp;</span><span class="keyword operator assignment js"><span>=</span></span><span>&nbsp;url</span><span class="punctuation terminator statement js"><span>;</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta brace curly js"><span>}</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span>&nbsp;&nbsp;</span><span class="punctuation definition function body end bracket curly js"><span>}</span></span><span class="meta brace round js"><span>)</span><span>(</span><span>)</span></span><span class="punctuation terminator statement js"><span>;</span></span></span></span></div><div class="line"><span class="text html basic"><span class="source js embedded html"><span class="punctuation definition tag html"><span>&lt;/</span></span><span class="entity name tag script html"><span>script</span></span><span class="punctuation definition tag html"><span>&gt;</span></span></span></span></div></code></pre>
<p>This isn’t perfect, but it’s a quick check to see if the user’s browser supports native modules, since support for that is correlated with support for newer JS syntax. If the support is there, it won’t run. If the support isn’t there, it’ll run and redirect the user to the same page, with <code>forceFallback=1</code> appended as a URL parameter.</p>
<p>You’d then need to add support for this to the server-side, so that it would always return the fallback build when <code>forceFallback=1</code> is provided.</p>
<h2 id="caveats">Caveats</h2>
<p>Do remember that you now have extra dependencies in the form of <code>browserslist</code> and <code>browserslist-useragent</code>, on the server-side. This means that you should build and deploy often, making sure to pick up new versions of these dependencies (perhaps using a service like <a href="https://renovatebot.com/">Renovate</a> or <a href="https://greenkeeper.io/">Greenkeeper</a>), so that they’re aware of new browser releases.</p>
<p>This is particularly important if you’re using rules in the form of <code>latest 2 firefox versions</code>, since the meaning of “latest” is based on what version of <code>browserslist</code> you’re using and what browser versions were out at the time. The call to <code>matchesUA</code> we added above has some safeguards for unknown new versions, but these safeguards are not guaranteed to work.</p>
<p>Still, even in this scenario, the failure mode is to serve up the fallback bundle instead of the evergreen one. That’s not ideal, but it is what would be happening anyway before you implemented multiple build targets!</p>
<p>Another important consideration is to make sure that you’re testing regularly, and doing so in multiple browsers. This is something you should try to do anyway, but it becomes particularly relevant when you’re providing different code to different users, and doubly so when one of those versions is unlikely to run in the developer’s browser. An automated set of end-to-end tests is an excellent practice that helps with this.</p>
<h2 id="conclusions">Conclusions</h2>
<p>At the end of this process, you should now have two builds, with minimal changes to your build process and application code.</p>
<p>Users of old browsers will still get slow, large builds — but they actually need to. Everyone who keeps their browser up-to-date will instead get a leaner, faster build that makes use of the functionality already built into their browsers.</p>
<p>This comes with some extra maintenance costs for you, as a developer. But it’s largely automatable, and until you can drop support for older browsers, that tradeoff may well be worth it. Users come first 🙂</p>


  </div>

  <div class="post-tags">
      <span class="post-tags-head">Tags:&nbsp;</span>
      <div class="post-tags-list">
        
          bundling
        
          performance
        
      </div>
  </div>
</article>

    </main>

    <footer class="footer">
  <div class="footer-contents">
    <img class="footer-avatar" src="/assets/images/avatar.jpg" alt="Author's avatar">

    <div class="footer-text">
      <h2 class="footer-heading">Hey there!</h2>
      <p class="footer-description">I’m Sérgio, and I work with Web frontend code. Sometimes I write about it here.</p>
    </div>

    <div class="footer-icons">
      <div class="footer-icons-row">
        <a href="https://twitter.com/sergiomdgomes" class="footer-bubble footer-twitter" aria-label="Author's Twitter page"></a>
        <a href="mailto:mail@sgom.es" class="footer-bubble footer-email" aria-label="Author's email address"></a>
      </div>
      <div class="footer-icons-row">
        <a href="/feed.xml" class="footer-bubble footer-feed" aria-label="Atom feed for this site"></a>
        <a href="https://github.com/sgomes" class="footer-bubble footer-github" aria-label="Author's GitHub profile'"></a>
      </div>
    </div>
  </div>
  <div class="footer-bottom">
    <div class="footer-copyright">Articles under
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons 4.0 Attribution</a>,
    code under <a rel="license" href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0</a>
    (unless otherwise indicated).</div>
  </div>
</footer>


  </body>

</html>
